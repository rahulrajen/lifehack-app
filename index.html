<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lifehack App</title>
    <!-- Tailwind CSS via CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #4b0082 0%, #8a2be2 100%);
            min-height: 100vh;
        }
        .app-title {
            font-family: 'Press Start 2P', cursive;
            color: #40e0d0; /* Turquoise */
            text-shadow: 2px 2px #2f1d4f;
        }
        .welcome-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            background: linear-gradient(135deg, #4b0082 0%, #8a2be2 100%);
            color: #fff;
            z-index: 100;
            transition: opacity 1s ease-in-out;
        }
        .modal-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 101;
            padding: 24px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 400px;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-between p-4">

    <!-- Welcome Page -->
    <div id="welcomePage" class="welcome-page p-4">
        <h1 id="welcomeMessage" class="text-4xl sm:text-6xl font-bold mb-4 app-title animate-pulse">Welcome</h1>
        <p id="quoteText" class="text-xl sm:text-2xl italic max-w-lg mx-auto text-gray-200 mt-8"></p>
        
        <!-- Conditional input fields for new users -->
        <div id="welcomeInputs" class="hidden mt-8 w-full max-w-sm p-4 bg-purple-900 bg-opacity-70 rounded-xl shadow-lg space-y-4">
            <h3 class="text-xl font-bold text-gray-100">Let's get started!</h3>
            <input type="text" id="usernameInput" placeholder="Enter your username" class="w-full p-3 rounded-lg border border-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-purple-800 text-gray-100 placeholder-gray-400" />
            <input type="number" id="baseValueInput" placeholder="Enter your daily target score" class="w-full p-3 rounded-lg border border-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-purple-800 text-gray-100 placeholder-gray-400" />
            <button id="startAppBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-colors">Start</button>
        </div>

        <!-- Modal overlay -->
        <div id="modalOverlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
                <p id="modalMessage" class="text-lg text-red-500 font-semibold mb-4 text-center"></p>
                <button id="closeButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="mainApp" class="w-full max-w-2xl bg-white bg-opacity-10 backdrop-blur-sm rounded-xl shadow-lg p-6 flex-col justify-between hidden" style="min-height: 90vh;">
        <!-- Title section -->
        <div class="mb-8">
            <h1 class="app-title text-4xl text-center mb-2">Lifehack</h1>
            <p class="text-center text-gray-300 mb-6">A collection of smart tips to simplify your life.</p>
            <p id="userIdDisplay" class="text-xs text-gray-400 text-center"></p>
        </div>
        
        <!-- Main content area -->
        <div id="pageContent" class="flex-grow w-full overflow-y-auto p-4 rounded-xl">
            <!-- Content will be rendered here -->
        </div>

        <!-- Navigation buttons at the bottom -->
        <div id="navigation" class="mt-8 flex justify-around items-center w-full bg-purple-900 bg-opacity-70 p-4 rounded-xl shadow-inner">
            <button id="homeBtn" class="nav-btn text-gray-200 hover:text-turquoise-400 font-bold py-2 px-4 rounded-lg transition-colors">Home</button>
            <button id="historyBtn" class="nav-btn text-gray-200 hover:text-turquoise-400 font-bold py-2 px-4 rounded-lg transition-colors">History</button>
            <button id="settingsBtn" class="nav-btn text-gray-200 hover:text-turquoise-400 font-bold py-2 px-4 rounded-lg transition-colors">Settings</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // UI elements
        const welcomePage = document.getElementById('welcomePage');
        const mainApp = document.getElementById('mainApp');
        const pageContent = document.getElementById('pageContent');
        const modalOverlay = document.getElementById('modalOverlay');
        const modalMessage = document.getElementById('modalMessage');
        const closeButton = document.getElementById('closeButton');
        const homeBtn = document.getElementById('homeBtn');
        const historyBtn = document.getElementById('historyBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const welcomeMessageEl = document.getElementById('welcomeMessage');
        const quoteTextEl = document.getElementById('quoteText');
        const welcomeInputsEl = document.getElementById('welcomeInputs');
        const usernameInputEl = document.getElementById('usernameInput');
        const baseValueInputEl = document.getElementById('baseValueInput');
        const startAppBtn = document.getElementById('startAppBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');

        let app, db, auth, userId, userDocRef;
        let isAuthReady = false;

        let settings = {
            username: '',
            baseValue: '',
            resetTime: '00:00'
        };
        let items = [];
        let dailyTotal = 0;
        let completedItems = [];
        let dailyHistory = [];

        const motivationalQuotes = [
            "Motivation is what gets you started. Habit is what keeps you going.",
            "The secret to a good habit is to start small and make it easy.",
            "Success is the sum of small efforts, repeated day in and day out.",
            "Habits are the foundation of your success. Start building a strong one today.",
            "A small habit today can lead to a great future tomorrow."
        ];

        const showModal = (message) => {
            modalMessage.textContent = message;
            modalOverlay.classList.remove('hidden');
        };

        const closeModal = () => {
            modalOverlay.classList.add('hidden');
            modalMessage.textContent = '';
        };

        const saveDailyTotal = async () => {
            if (dailyTotal === 0) {
                showModal('Daily total is zero. No data to save.');
                return;
            }
            try {
                if (!userId) {
                    showModal("Authentication not ready. Please try again.");
                    return;
                }
                const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
                const historyCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/dailyHistory`);
                
                // Firestore doesn't have a direct 'update if exists, otherwise add' method like we had with localStorage.
                // We'll query to see if a document for today's date already exists.
                const todayDocRef = doc(historyCollectionRef, today);
                const docSnap = await getDoc(todayDocRef);

                if (docSnap.exists()) {
                    await updateDoc(todayDocRef, { score: dailyTotal });
                } else {
                    await setDoc(todayDocRef, { score: dailyTotal, date: today });
                }
                showModal(`Daily total of ${dailyTotal} has been saved!`);
            } catch (error) {
                console.error('Error saving daily total:', error);
                showModal(`Error saving daily total: ${error.message}`);
            }
        };

        const fetchAndRenderHistory = () => {
            const historyContainer = document.getElementById('historyContent');
            if (!historyContainer) return; // Check if the element exists

            if (dailyHistory.length > 0) {
                historyContainer.innerHTML = '';
                
                // Create and append the graph
                const graphContainer = document.createElement('div');
                graphContainer.className = 'p-4 mb-6 bg-purple-900 bg-opacity-70 rounded-xl shadow-lg border border-purple-700';
                const graphTitle = document.createElement('h3');
                graphTitle.className = 'text-xl font-bold text-turquoise-400 text-center mb-4';
                graphTitle.textContent = 'Daily Score Trend';
                const scoreGraph = document.createElement('div');
                scoreGraph.className = 'flex justify-around items-end h-40';
                
                graphContainer.appendChild(graphTitle);
                graphContainer.appendChild(scoreGraph);
                historyContainer.appendChild(graphContainer);
                
                const sortedHistory = [...dailyHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
                const maxScore = Math.max(...sortedHistory.map(entry => entry.score));

                sortedHistory.forEach(entry => {
                    const score = entry.score;
                    const barHeight = maxScore > 0 ? (score / maxScore) * 100 : 0;
                    const bar = document.createElement('div');
                    bar.className = 'flex flex-col justify-end items-center mx-1';
                    bar.style.width = `${100 / sortedHistory.length - 2}%`;
                    bar.innerHTML = `
                        <div class="w-full bg-turquoise-400 rounded-t-full transition-all duration-500" style="height: ${barHeight}%;"></div>
                        <span class="text-xs text-gray-300 mt-1">${score}</span>
                        <span class="text-xs text-gray-400 rotate-90" style="white-space: nowrap; transform-origin: left; margin-left: 1rem;">${entry.date}</span>
                    `;
                    scoreGraph.appendChild(bar);
                });

                // Create and append the list of scores
                const list = document.createElement('div');
                list.className = 'space-y-4';
                [...dailyHistory].reverse().forEach(entry => {
                    const dayEntry = document.createElement('div');
                    dayEntry.className = 'p-4 bg-purple-500 bg-opacity-30 rounded-xl shadow-lg border border-purple-700';
                    dayEntry.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold text-turquoise-400">${entry.date}</h3>
                            <span class="text-gray-100 text-lg">${entry.score} points</span>
                        </div>
                    `;
                    list.appendChild(dayEntry);
                });
                historyContainer.appendChild(list);
            } else {
                historyContainer.innerHTML = `<p class="text-center text-gray-400 text-lg">No daily scores found in your history.</p>`;
            }
        };

        const renderItemsPage = () => {
            pageContent.innerHTML = '';
            
            const renderDisplayMode = () => {
                const listItemsHtml = items.map((item, index) => {
                    const isCompleted = completedItems.includes(index);
                    return `
                        <div class="flex items-center justify-between p-4 rounded-xl shadow-lg border transition-colors ${isCompleted ? 'bg-green-700 bg-opacity-50 border-green-500 cursor-default' : 'bg-purple-500 bg-opacity-30 border-purple-700 cursor-pointer hover:bg-opacity-50'}" data-points="${item.points}" data-index="${index}">
                            <span class="text-gray-100 text-lg">${item.text}</span>
                            <span class="${isCompleted ? 'text-white' : 'text-turquoise-400'} font-semibold">${isCompleted ? 'âœ“ Completed' : `+${item.points}`}</span>
                        </div>
                    `;
                }).join('');
                
                const contentHtml = `
                    <div class="relative p-8 text-gray-300">
                        <div id="editBtnContainer" class="absolute top-4 right-4">
                            <button id="editItemsBtn" class="p-2 rounded-full hover:bg-purple-700 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                        </div>
                        <h2 class="text-3xl font-bold mb-4">Daily Habits</h2>
                        <div class="text-center mb-6">
                            <p class="text-xl">Daily Score</p>
                            <span id="dailyTotal" class="text-6xl font-bold text-turquoise-400">${dailyTotal}</span>
                        </div>
                        <div class="space-y-4">
                            ${listItemsHtml}
                        </div>
                        <div class="flex justify-center gap-4 mt-6">
                            <button id="saveTotalBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-colors">Save Total</button>
                            <button id="resetTotalBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-colors">Reset</button>
                        </div>
                    </div>
                `;
                pageContent.innerHTML = contentHtml;

                document.querySelectorAll('[data-points]').forEach(itemEl => {
                    itemEl.addEventListener('click', async () => {
                        if (!isAuthReady) {
                            showModal("Authentication not ready. Please wait a moment.");
                            return;
                        }
                        const index = parseInt(itemEl.getAttribute('data-index'));
                        if (!completedItems.includes(index)) {
                            const pointsToAdd = parseInt(itemEl.getAttribute('data-points'));
                            dailyTotal += pointsToAdd;
                            completedItems.push(index);

                            try {
                                await updateDoc(userDocRef, {
                                    dailyTotal: dailyTotal,
                                    completedItems: completedItems
                                });
                            } catch (e) {
                                console.error("Error updating daily total:", e);
                                showModal("Failed to update daily total. Please try again.");
                            }
                        }
                    });
                });
                
                document.getElementById('editItemsBtn').addEventListener('click', renderEditMode);
                document.getElementById('saveTotalBtn').addEventListener('click', saveDailyTotal);
                document.getElementById('resetTotalBtn').addEventListener('click', async () => {
                    dailyTotal = 0;
                    completedItems = [];
                    try {
                        await updateDoc(userDocRef, {
                            dailyTotal: dailyTotal,
                            completedItems: completedItems
                        });
                    } catch (e) {
                         console.error("Error resetting daily total:", e);
                         showModal("Failed to reset daily total. Please try again.");
                    }
                });
            };

            const renderEditMode = () => {
                const itemsHtml = items.map((item, index) => `
                    <div class="flex gap-4 items-center" data-index="${index}">
                        <input type="text" value="${item.text}" placeholder="Habit Text" class="item-text flex-grow p-2 rounded-lg border border-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-purple-900 text-gray-100 placeholder-gray-400" />
                        <input type="number" value="${item.points}" placeholder="Points" class="item-points w-24 p-2 rounded-lg border border-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-purple-900 text-gray-100 placeholder-gray-400" />
                        <button class="delete-btn p-2 rounded-full bg-red-600 hover:bg-red-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `).join('');
                
                const contentHtml = `
                    <div class="p-8 text-gray-300">
                        <h2 class="text-3xl font-bold mb-6">Edit Daily Habits</h2>
                        <div id="item-inputs" class="space-y-4 mb-6">
                            ${itemsHtml}
                        </div>
                        <div class="flex justify-center mb-6">
                            <button id="addItemBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-full shadow-md transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                            </button>
                        </div>
                        <div class="flex justify-center">
                            <button id="saveItemsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-colors">Save Items</button>
                        </div>
                    </div>
                `;
                pageContent.innerHTML = contentHtml;

                document.getElementById('addItemBtn').addEventListener('click', () => {
                    const itemInputsContainer = document.getElementById('item-inputs');
                    const newItemInputDiv = document.createElement('div');
                    newItemInputDiv.className = 'flex gap-4 items-center';
                    newItemInputDiv.innerHTML = `
                        <input type="text" placeholder="Habit Text" class="item-text flex-grow p-2 rounded-lg border border-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-purple-900 text-gray-100 placeholder-gray-400" />
                        <input type="number" placeholder="Points" class="item-points w-24 p-2 rounded-lg border border-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-purple-900 text-gray-100 placeholder-gray-400" />
                        <button class="delete-btn p-2 rounded-full bg-red-600 hover:bg-red-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    itemInputsContainer.appendChild(newItemInputDiv);
                });
                
                document.getElementById('saveItemsBtn').addEventListener('click', async () => {
                    const newItems = [];
                    document.querySelectorAll('#item-inputs > div').forEach(div => {
                        const textInput = div.querySelector('.item-text');
                        const pointsInput = div.querySelector('.item-points');
                        if (textInput.value.trim() && pointsInput.value) {
                            newItems.push({
                                text: textInput.value.trim(),
                                points: parseInt(pointsInput.value)
                            });
                        }
                    });
                    items = newItems;
                    try {
                        await updateDoc(userDocRef, {
                            items: JSON.stringify(items)
                        });
                        renderDisplayMode();
                    } catch (e) {
                         console.error("Error saving items:", e);
                         showModal("Failed to save items. Please try again.");
                    }
                });

                document.getElementById('item-inputs').addEventListener('click', async (e) => {
                    const deleteBtn = e.target.closest('.delete-btn');
                    if (deleteBtn) {
                        const itemDiv = deleteBtn.closest('[data-index]');
                        if (itemDiv) {
                            const index = parseInt(itemDiv.dataset.index);
                            items.splice(index, 1);
                            try {
                                await updateDoc(userDocRef, {
                                    items: JSON.stringify(items)
                                });
                                renderEditMode();
                            } catch (e) {
                                console.error("Error deleting item:", e);
                                showModal("Failed to delete item. Please try again.");
                            }
                        }
                    }
                });
            };

            if (items.length === 0) {
                renderEditMode();
            } else {
                renderDisplayMode();
            }
        };

        const renderPage = (page) => {
            pageContent.innerHTML = '';
            
            if (page === 'home') {
                const baseTargetScore = settings.baseValue || 'Not set';
                const username = settings.username || 'User';

                const homeHtml = `
                    <div id="homePageContent">
                        <div id="homeTop" class="p-6 mb-4 rounded-xl shadow-lg border border-purple-700 bg-purple-700 bg-opacity-50 cursor-pointer hover:bg-opacity-70 transition-colors">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-turquoise-400">Welcome, ${username}!</h3>
                                <span class="text-lg font-bold text-gray-100">Target: ${baseTargetScore}</span>
                            </div>
                            <div class="flex flex-col items-center justify-center text-gray-400 text-center">
                                <p class="text-lg font-bold text-gray-200">View Daily Score History</p>
                                <p>Click here to see your trend graph!</p>
                            </div>
                        </div>
                        <div id="homeMid" class="p-6 mb-4 rounded-xl shadow-lg border border-purple-700 bg-purple-700 bg-opacity-50 cursor-pointer hover:bg-opacity-70 transition-colors flex flex-col items-center justify-center">
                            <h3 class="text-3xl font-bold text-gray-100">Daily Habits</h3>
                            <p class="text-gray-300">Start tracking your progress!</p>
                        </div>
                        <div id="homeBottom" class="p-6 rounded-xl shadow-lg border border-purple-700 bg-purple-700 bg-opacity-50 flex items-center justify-center text-gray-400">
                            <p>Future Use Section</p>
                        </div>
                    </div>
                `;
                pageContent.innerHTML = homeHtml;
                
                document.getElementById('homeTop').addEventListener('click', () => renderPage('history'));
                document.getElementById('homeMid').addEventListener('click', () => renderPage('items'));
            } else if (page === 'history') {
                const contentHtml = `
                    <div class="text-center p-4 text-gray-300">
                        <h2 class="text-3xl font-bold mb-4">History</h2>
                        <div id="historyContent" class="text-left">
                            <!-- History will be rendered here -->
                        </div>
                    </div>
                `;
                pageContent.innerHTML = contentHtml;
                fetchAndRenderHistory();
            } else if (page === 'settings') {
                const contentHtml = `
                    <div class="relative text-center p-8 text-gray-300">
                        <div id="editBtnContainer" class="absolute top-4 right-4">
                            <button id="editSettingsBtn" class="p-2 rounded-full hover:bg-purple-700 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                        </div>
                        <h2 class="text-3xl font-bold mb-4">Settings</h2>
                        <div id="displayMode" class="space-y-6">
                            <div class="flex items-center justify-between">
                                <p class="text-xl">Username:</p>
                                <p id="usernameDisplay" class="font-semibold text-turquoise-400 text-xl">${settings.username}</p>
                            </div>
                            <div class="flex items-center justify-between">
                                <p class="text-xl">Base Value:</p>
                                <p id="baseValueDisplay" class="font-semibold text-turquoise-400 text-xl">${settings.baseValue || 'Not set'}</p>
                            </div>
                            <div class="flex items-center justify-between">
                                <p class="text-xl">Daily Reset Time:</p>
                                <p id="resetTimeDisplay" class="font-semibold text-turquoise-400 text-xl">${settings.resetTime}</p>
                            </div>
                        </div>

                        <div id="editMode" class="hidden mt-8 space-y-6">
                            <div class="flex flex-col gap-2">
                                <label for="usernameInputSettings" class="text-left text-lg">Maintain Username</label>
                                <input type="text" id="usernameInputSettings" placeholder="Enter new username" class="flex-grow p-2 rounded-lg border border-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-purple-900 text-gray-100 placeholder-gray-400" value="${settings.username}" />
                            </div>
                            <div class="flex flex-col gap-2">
                                <label for="baseValueInputSettings" class="text-left text-lg">Maintain Base Value</label>
                                <input type="number" id="baseValueInputSettings" placeholder="Enter base value" class="flex-grow p-2 rounded-lg border border-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-purple-900 text-gray-100 placeholder-gray-400" value="${settings.baseValue}" />
                            </div>
                            <div class="flex flex-col gap-2">
                                <label for="resetTimeInput" class="text-left text-lg">Daily Reset Time</label>
                                <input type="time" id="resetTimeInput" class="p-2 rounded-lg border border-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-purple-900 text-gray-100 placeholder-gray-400" value="${settings.resetTime}" />
                            </div>
                        </div>
                    </div>
                `;
                pageContent.innerHTML = contentHtml;
                 const editBtn = document.getElementById('editSettingsBtn');
                 const displayMode = document.getElementById('displayMode');
                 const editMode = document.getElementById('editMode');
                 const baseValueInputSettings = document.getElementById('baseValueInputSettings');
                 const usernameInputSettings = document.getElementById('usernameInputSettings');
                 const resetTimeInput = document.getElementById('resetTimeInput');
                 
                 let isEditing = false;
                 
                 const toggleEditMode = async () => {
                     isEditing = !isEditing;
                     if (isEditing) {
                         displayMode.classList.add('hidden');
                         editMode.classList.remove('hidden');
                         editBtn.innerHTML = '<button id="doneSettingsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors">Done</button>';
                     } else {
                         const newSettings = {
                             baseValue: baseValueInputSettings.value,
                             username: usernameInputSettings.value,
                             resetTime: resetTimeInput.value
                         };
                         settings.baseValue = newSettings.baseValue;
                         settings.username = newSettings.username;
                         settings.resetTime = newSettings.resetTime;
                         
                         try {
                             await setDoc(userDocRef, { settings: newSettings }, { merge: true });
                             document.getElementById('usernameDisplay').textContent = newSettings.username;
                             document.getElementById('baseValueDisplay').textContent = newSettings.baseValue || 'Not set';
                             document.getElementById('resetTimeDisplay').textContent = newSettings.resetTime;
                         } catch (e) {
                             console.error("Error updating settings:", e);
                             showModal("Failed to save settings. Please try again.");
                         }
                         
                         displayMode.classList.remove('hidden');
                         editMode.classList.add('hidden');
                         editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                                </svg>`;
                     }
                 };
                 editBtn.addEventListener('click', toggleEditMode);
            } else if (page === 'items') {
                renderItemsPage();
            }
        };

        const goToMainApp = () => {
            welcomePage.classList.add('hidden');
            mainApp.classList.remove('hidden');
            mainApp.classList.add('flex');
            renderPage('home');
        };

        // Firebase Initialization and Authentication
        const initFirebase = async () => {
            try {
                if (!firebaseConfig.apiKey) {
                    showModal("Firebase config is missing. Please ensure your environment is set up correctly.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // The onAuthStateChanged listener is the single entry point for authenticated users.
                // It correctly waits for Firebase Auth to be initialized before executing.
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        userDocRef = doc(db, `artifacts/${appId}/users/${userId}/data/userData`);

                        const docSnap = await getDoc(userDocRef);
                        if (docSnap.exists() && docSnap.data().settings?.username && docSnap.data().settings?.baseValue) {
                            const { username } = docSnap.data().settings;
                            welcomeMessageEl.textContent = `Welcome ${username}!`;
                            const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
                            quoteTextEl.textContent = randomQuote;
                            
                            const welcomeTimeout = setTimeout(goToMainApp, 1000); // 1 seconds timeout
                            const skipWelcome = () => {
                                clearTimeout(welcomeTimeout);
                                goToMainApp();
                            };
                            welcomePage.addEventListener('click', skipWelcome);
                            welcomePage.addEventListener('touchstart', skipWelcome);

                        } else {
                            welcomeMessageEl.textContent = `Welcome!`;
                            const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
                            quoteTextEl.textContent = randomQuote;
                            welcomeInputsEl.classList.remove('hidden');

                            startAppBtn.addEventListener('click', async () => {
                                const newUsername = usernameInputEl.value.trim();
                                const newBaseValue = baseValueInputEl.value.trim();
                                
                                if (newUsername && newBaseValue) {
                                    try {
                                        await setDoc(userDocRef, {
                                            settings: { 
                                                username: newUsername, 
                                                baseValue: newBaseValue,
                                                resetTime: '00:00'
                                            },
                                            dailyTotal: 0,
                                            completedItems: [],
                                            items: JSON.stringify([]),
                                            lastResetDate: new Date().toDateString()
                                        }, { merge: true });
                                        goToMainApp();
                                    } catch (e) {
                                        console.error("Error saving initial settings:", e);
                                        showModal("Failed to start app. Please try again.");
                                    }
                                } else {
                                    showModal('Please enter both a username and a daily target score to get started.');
                                }
                            });
                        }

                        await setupFirestoreListeners();
                        isAuthReady = true;

                    } else {
                        // Handle sign-out state if necessary
                        console.log("User signed out.");
                        isAuthReady = false;
                    }
                });

            } catch (e) {
                console.error("Error initializing Firebase:", e);
                showModal(`Firebase initialization failed: ${e.message}`);
            }
        };

        const setupFirestoreListeners = async () => {
            const docSnap = await getDoc(userDocRef);
            if (!docSnap.exists()) {
                 const docData = {
                    settings: {
                        username: "",
                        baseValue: "",
                        resetTime: '00:00'
                    },
                    items: JSON.stringify([]),
                    dailyTotal: 0,
                    completedItems: [],
                    lastResetDate: new Date().toDateString()
                };
                await setDoc(userDocRef, docData);
            }

            onSnapshot(userDocRef, (doc) => {
                const data = doc.data();
                if (data) {
                    settings.username = data.settings?.username || '';
                    settings.baseValue = data.settings?.baseValue || '';
                    settings.resetTime = data.settings?.resetTime || '00:00';
                    items = data.items ? JSON.parse(data.items) : [];
                    dailyTotal = data.dailyTotal || 0;
                    completedItems = data.completedItems || [];
                    const lastResetDate = data.lastResetDate;
                    const today = new Date().toDateString();
                    const now = new Date();
                    const [resetHour, resetMinute] = settings.resetTime.split(':').map(Number);
                    const resetTimeToday = new Date();
                    resetTimeToday.setHours(resetHour, resetMinute, 0, 0);

                    // Logic to check if a reset should occur
                    let shouldReset = false;
                    const lastResetDateObj = new Date(lastResetDate);
                    
                    // Case 1: The app hasn't been used since the last calendar day.
                    if (lastResetDate !== today) {
                        shouldReset = true;
                    }
                    // Case 2: The app was used today, but it was before the reset time, and now it's after.
                    else if (now.getTime() >= resetTimeToday.getTime()) {
                         const lastResetTimeObj = new Date(lastResetDateObj);
                         lastResetTimeObj.setHours(resetHour, resetMinute, 0, 0);
                         if(now.getTime() > lastResetTimeObj.getTime()) {
                             shouldReset = true;
                         }
                    }

                    if (shouldReset) {
                        dailyTotal = 0;
                        completedItems = [];
                        updateDoc(userDocRef, { dailyTotal: 0, completedItems: [], lastResetDate: today });
                    }
                }
            }, (error) => {
                console.error("Error listening to user data:", error);
                showModal("Failed to load user data. Please check your connection.");
            });

            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/dailyHistory`), (snapshot) => {
                const historyData = [];
                snapshot.forEach((doc) => {
                    historyData.push(doc.data());
                });
                dailyHistory = historyData;
                fetchAndRenderHistory();
            }, (error) => {
                console.error("Error listening to daily history:", error);
                showModal("Failed to load history data.");
            });
        };

        window.onload = function() {
            closeButton.addEventListener('click', closeModal);
            homeBtn.addEventListener('click', () => renderPage('home'));
            historyBtn.addEventListener('click', () => renderPage('history'));
            settingsBtn.addEventListener('click', () => renderPage('settings'));

            initFirebase();
        };
    </script>
</body>
</html>
